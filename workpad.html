<!doctype html>
<html>

<head>
    <title>Workpad</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-multi-stim-multi-response.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-html.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body>
</body>
<script>
var timeline = [];

var test = {
    type: 'text',
    text: 'Press any key to continue'
}

var countdown_slow = {
    type: 'multi-stim-multi-response',
    stimuli: ['3', '2', '1'],
    is_html: true,
    choices: [],
    prompt: 'Press "g" for ROCK, "h" for PAPER, or "b" for SCISSORS',
    timing_stim: [700, 700, 700],
    timing_response: 2100,
    response_ends_trial: false,
    data: {
        block_task: 'countdown_slow_text'
    }
}

var go_trial = {
    type: 'single-stim',
    is_html: true,
    stimulus: 'GO!',
    choices: ['g', 'h', 'b'],
    timing_response: 500,
    response_ends_trial: true,
    data: {
        block_task: 'practice_go'
    },
    on_finish: function(data) {
        if (data.key_press == -1) {
            jsPsych.data.addDataToLastTrial({
                answer_status: 'missed'
            });
        } else {
            jsPsych.data.addDataToLastTrial({
                answer_status: 'answered'
            });
        }
    }
}

var missed = {
    type: 'single-stim',
    is_html: true,
    stimulus: 'TOO LATE!',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'missed_text'
    }
}

var if_missed = {
    timeline: [missed],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == -1) {
            return true;
        } else {
            return false;
        }
    }
}

var show_rock_image = {
    type: 'single-stim',
    stimulus: 'img/RPSimage1.png',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'rock_image'
    }
}

var show_paper_image = {
    type: 'single-stim',
    stimulus: 'img/RPSimage2.png',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'paper_image'
    }
}

var show_scissor_image = {
    type: 'single-stim',
    stimulus: 'img/RPSimage3.png',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'scissors_image'
    }
}

var if_rock = {
    timeline: [show_rock_image],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == 71) {
            return true;
        } else {
            return false;
        }
    }
}

var if_paper = {
    timeline: [show_paper_image],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == 72) {
            return true;
        } else {
            return false;
        }
    }
}

var if_scissor = {
    timeline: [show_scissor_image],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == 66) {
            return true;
        } else {
            return false;
        }
    }
}

var practice_loop = {
    timeline: [
        countdown_slow, go_trial, if_missed, if_rock, if_paper, if_scissor
    ],
    loop_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.block_task == 'rock_image' || data.block_task == 'paper_image' || data.block_task == 'scissors_image'){
            return false;
        } else if (data.block_task == 'missed_text'){
            return true;
        }
    }
}

function getSubjectData() {
    var trials = jsPsych.data.getTrialsOfType('single-stim');

    var total_answered = 0;
    var total_missed = 0;
    var total_rock = 0;
    var total_paper = 0;
    var total_scissor = 0;
    for (var i = 0; i < trials.length; i++) {
        if (trials[i].answer_status == 'answered') {
            total_answered++;
            if (trials[i].key_press == 71) {
                total_rock++;
            } else if (trials[i].key_press == 72) {
                total_paper++;
            } else if (trials[i].key_press == 66) {
                total_scissor++;
            }
        } else if (trials[i].answer_status == 'missed') {
            total_missed++;
        }
    }
    return {
        rock: total_rock,
        paper: total_paper,
        scissor: total_scissor,
        answered: total_answered,
        missed: total_missed
    }
}

var debrief_block = {
    type: 'text',
    text: function() {
        var subjectData = getSubjectData();
        return "<p>You generated a total of " + subjectData.answered + " RPS events, and you missed " + subjectData.missed + " total events.</p>" +
            "<p>Total rock: " + subjectData.rock + "</p><p>Total paper: " + subjectData.paper + "</p><p>Total Scissor: " + subjectData.scissor + "</p>";
    }
}

timeline.push(test);

for (var i = 0; i < 5; i++) {
    timeline.push(practice_loop);
}

timeline.push(debrief_block);

jsPsych.init({
    timeline: timeline,
    default_iti: 100,
    on_finish: function() {
        jsPsych.data.displayData('csv');
    }
});
</script>

</html>
