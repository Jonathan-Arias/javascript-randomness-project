<!doctype html>
<html>

<head>
    <title>Randomness Experiment</title>
    <script src="jspsych-5.0.3/jquery.min.js"></script>
    <script src="jspsych-5.0.3/jspsych.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-text.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-single-stim.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-multi-stim-multi-response.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-html.js"></script>
    <script src="jspsych-5.0.3/plugins/jspsych-survey-likert.js"></script>
    <script src="functions.js"></script>
    <script src="instruction-blocks.js"></script>
    <script src="game-states.js"></script>
    <link href="jspsych-5.0.3/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body>
</body>
<script>
// generate a random 15-character string for subject ID
var subject_id = jsPsych.randomization.randomID(15)

// pick a random condition for the subject at the start of the experiment
var condition = jsPsych.randomization.sample(['aware_predict', 'unaware_predict', 'unaware_no_predict'], 1)

// extra data to be added to each trial
jsPsych.data.addProperties({
    subject: subject_id,
    condition: condition
})

// define countdown block for practice trials (600 ms)
var countdown_slow = {
    type: 'multi-stim-multi-response',
    stimuli: ['3', '2', '1'],
    is_html: true,
    choices: [],
    prompt: 'Press "g" for ROCK, "h" for PAPER, or "b" for SCISSORS',
    timing_stim: [600, 600, 600],
    timing_response: 1800,
    response_ends_trial: false,
    data: {
        block_task: 'countdown_trial_practice'
    }
}

// define countdown block for part 1 (500 ms)
var countdown_trial_part1 = {
    type: 'multi-stim-multi-response',
    stimuli: ['3', '2', '1'],
    is_html: true,
    choices: [],
    prompt: 'Press "g" for ROCK, "h" for PAPER, or "b" for SCISSORS',
    timing_stim: [500, 500, 500],
    timing_response: 1500,
    response_ends_trial: false,
    data: {
        block_task: 'countdown_trial_part1'
    }
}

// define countdown block for part 2 (400 ms)
var countdown_trial_part2 = {
    type: 'multi-stim-multi-response',
    stimuli: ['3', '2', '1'],
    is_html: true,
    choices: [],
    prompt: 'Press "g" for ROCK, "h" for PAPER, or "b" for SCISSORS',
    timing_stim: [400, 400, 400],
    timing_response: 1200,
    response_ends_trial: false,
    data: {
        block_task: 'countdown_trial_part2'
    }
}

// define countdown block for part 3 (300 ms)
var countdown_trial_part3 = {
    type: 'multi-stim-multi-response',
    stimuli: ['3', '2', '1'],
    is_html: true,
    choices: [],
    prompt: 'Press "g" for ROCK, "h" for PAPER, or "b" for SCISSORS',
    timing_stim: [300, 300, 300],
    timing_response: 900,
    response_ends_trial: false,
    data: {
        block_task: 'countdown_trial_part3'
    }
}

// define go block, collect response from subject
var go_trial = {
    type: 'single-stim',
    is_html: true,
    stimulus: 'GO!',
    choices: ['g', 'h', 'b'],
    timing_response: 500,
    response_ends_trial: true,
    data: {
        block_task: 'go_text'
    },
    on_finish: function(data) {
        if (data.key_press == -1) {
            jsPsych.data.addDataToLastTrial({
                answer_status: 'missed'
            });
        } else {
            jsPsych.data.addDataToLastTrial({
                answer_status: 'answered'
            });
        }
    }
}

// define missed block, flashes if subject took over 500 ms to respond in go block
var missed = {
    type: 'single-stim',
    is_html: true,
    stimulus: 'TOO LATE!',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'missed_text'
    }
}

// conditional block to check if subject missed response
var if_missed = {
    timeline: [missed],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == -1) {
            return true;
        } else {
            return false;
        }
    }
}

// rock block, display the rock image for 500 ms
var show_rock_image = {
    type: 'single-stim',
    stimulus: 'img/RPSimage1.png',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'rock_image'
    }
}

// paper block, display the paper image for 500 ms
var show_paper_image = {
    type: 'single-stim',
    stimulus: 'img/RPSimage2.png',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'paper_image'
    }
}

// scissor block, display the scissor image for 500 ms
var show_scissor_image = {
    type: 'single-stim',
    stimulus: 'img/RPSimage3.png',
    timing_response: 500,
    response_ends_trial: false,
    data: {
        block_task: 'scissors_image'
    }
}

// conditional block, check if subject pressed 'g' for rock
var if_rock = {
    timeline: [show_rock_image],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == 71 && data.answer_status == 'answered') {
            return true;
        } else {
            return false;
        }
    }
}

// conditional block, check if subject pressed 'h' for paper
var if_paper = {
    timeline: [show_paper_image],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == 72 && data.answer_status == 'answered') {
            return true;
        } else {
            return false;
        }
    }
}

// conditional block, check if subject pressed 'b' for scissor
var if_scissor = {
    timeline: [show_scissor_image],
    conditional_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.key_press == 66 && data.answer_status == 'answered') {
            return true;
        } else {
            return false;
        }
    }
}

// practice block, loops until last trial is one of the RPS image blocks
var practice_loop = {
    timeline: [
        countdown_slow, go_trial, if_missed, if_rock, if_paper, if_scissor
    ],
    loop_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.block_task == 'rock_image' || data.block_task == 'paper_image' || data.block_task == 'scissors_image') {
            jsPsych.data.addDataToLastTrial({
                trial_data: 0
            });
            return false;
        } else if (data.block_task == 'missed_text') {
            return true;
        }
    }
}

// trial 1 block, loops until last trial is one of the RPS image blocks
var trial1_loop = {
    timeline: [
        countdown_trial_part1, go_trial, if_missed, if_rock, if_paper, if_scissor
    ],
    loop_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.block_task == 'rock_image' || data.block_task == 'paper_image' || data.block_task == 'scissors_image') {
            jsPsych.data.addDataToLastTrial({
                trial_data: 1
            });
            displayRPSCountInConsole(1);
            return false;
        } else if (data.block_task == 'missed_text') {
            return true;
        }
    }
}

// trial 2 block, loops until last trial is one of the RPS image blocks
var trial2_loop = {
    timeline: [
        countdown_slow, go_trial,
        if_missed_against_computer,
        if_rock_against_rock, if_rock_against_paper, if_rock_against_scissors,
        if_paper_against_rock, if_paper_against_paper, if_paper_against_scissors,
        if_scissors_against_rock, if_scissors_against_paper, if_scissors_against_scissors
    ],
    on_finish: function() {
        var data = jsPsych.data.getLastTrialData();
        jsPsych.data.addDataToLastTrial({
            trial_data: 2
        });
        displayRPSCountInConsole(2);
    }
}

// trial 3 block, loops until last trial is one of the RPS image blocks
var trial3_loop = {
    timeline: [
        countdown_trial_part3, go_trial, if_missed, if_rock, if_paper, if_scissor
    ],
    loop_function: function() {
        var data = jsPsych.data.getLastTrialData();
        if (data.block_task == 'rock_image' || data.block_task == 'paper_image' || data.block_task == 'scissors_image') {
            jsPsych.data.addDataToLastTrial({
                trial_data: 3
            });
            displayRPSCountInConsole(3);
            return false;
        } else if (data.block_task == 'missed_text') {
            return true;
        }
    }
}

// Scale for likert survey at end of experiment
var scale_1 = ["1 (Strongly Agree)", "2", "3", "4 (Neutral)", "5", "6", "7 (Strongly Disagree)"];

// Likert survey that presents three statements 
// Bug: subject can press enter without selecting any/all responses
var survey_block = {
    type: 'survey-likert',
    questions: [
        "I am confident that I know what a random sequence is.",
        "I am able to create a long, random sequence of Rock, Paper, and Scissors at will.",
        "I am able to recognize a random sequence of Rock, Paper, and Scissors when I see one"
    ],
    labels: [scale_1, scale_1, scale_1],
    data: {
        block_task: 'likert_survey'
    }
}

// displays the subject's performance at the end of the experiment
var debrief_block = {
    type: 'text',
    text: function() {
        var subjectData = getSubjectData();
        var all = collectAllSequences();
        var finalscore = collectWinLossTieProportion();
        var run = computeRunLength();
        return "<p>You generated a total of " + subjectData.answered + " RPS events, and you missed " + subjectData.missed + " total events.</p>" +
            "<p>Total rock: " + subjectData.rock + "</p><p>Total paper: " + subjectData.paper + "</p><p>Total Scissor: " + subjectData.scissor + "</p>" +
            "<p>Complete sequence: " + all.complete_sequence + "</p>" +
            "<p>Total wins: " + finalscore.wins + "</p><p> Total losses: " + finalscore.losses + "</p><p>Total ties: " +
            finalscore.ties + "</p><p> Total forfeits: " + finalscore.forfeits + "</p>" + 
            "<p>Run length: " + run.runarray.toString() + "</p>";
    }
}

// preliminary timeline prep
var timeline = [];
timeline.push(consent_block);
timeline.push(welcome_block);

// PART 1 INSTRUCTIONS
timeline.push(instructions_block1);

// DEBUGGING PURPOSES: variables to quickly adjust how many trials for each block
var total_trials = 3;

// PRACTICE BLOCK
// for (var i = 0; i < total_trials; i++) {
//     timeline.push(practice_loop);
// }

// timeline.push(practice_over);

// PART 1 - BLOCK 1
for (var i = 0; i < total_trials; i++) {
    timeline.push(trial1_loop);
}

// BREAK 1
timeline.push(shuffled_array[0]);

// PART 1 - BLOCK 2
for (var i = 0; i < total_trials; i++) {
    timeline.push(trial1_loop);
}

/* PART 2 INSTRUCTIONS */
if (condition == 'aware') {
    timeline.push(instructions_block2a); //a= aware+predict
} else if (condition == 'unaware_predict') {
    timeline.push(instructions_block2b); //b= unaware+predict
} else if (condition == 'unaware_no_predict') {
    timeline.push(instructions_block2c); //b= unaware+no predict
}

// PART 2 - BLOCK 1
for (var i = 0; i < total_trials; i++) {
    timeline.push(trial2_loop);
}

// BREAK 2
timeline.push(shuffled_array[1]);

// PART 2 - BLOCK 2
for (var i = 0; i < total_trials; i++) {
    timeline.push(trial2_loop);
}

// PART 3 INSTRUCTIONS
timeline.push(instructions_block3);

// PART 3 - BLOCK 1
for (var i = 0; i < total_trials; i++) {
    timeline.push(trial3_loop);
}

// BREAK 3
timeline.push(shuffled_array[2]);

// PART 3 - BLOCK 2
for (var i = 0; i < total_trials; i++) {
    timeline.push(trial3_loop);
}

// LIKERTY SURVEY
timeline.push(survey_block);

// Show subject data 
timeline.push(debrief_block);

// start the experiment
jsPsych.init({
    timeline: timeline,
    default_iti: 100,
    on_finish: function() {
        jsPsych.data.displayData('json');
    }
});
</script>

</html>
